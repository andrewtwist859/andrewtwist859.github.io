<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MARC Staff Directory</title>
  <link rel="stylesheet" href="https://use.typekit.net/jou7rrz.css">
  <style>
    body {
      font-family: 'source-sans-pro';
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }

    .search-box {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 1rem;
    }

    input[type="text"], select {
      padding: 10px;
      flex: 1 1 30%;
      min-width: 200px;
      border: 2px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
    }

    .clear-filters {
      background: none;
      border: none;
      color: #440099;
      text-decoration: underline;
      cursor: pointer;
      font-size: 1rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .profile-card {
      background-color: #fff;
      padding: 1rem;
      display: flex;
      flex-direction: row;
      gap: 1rem;
      align-items: flex-start;
      min-height: auto;
      border-bottom: 1px solid #eee;
    }

    .avatar {
      width: 60px;
      height: 60px;
      flex-shrink: 0;
      border-radius: 4px;
    }

    .profile-details {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      font-size: 0.95rem;
    }

    .name {
      font-family: 'source-serif-pro';
      font-size: 1.1rem;
      font-weight: bold;
      margin: 0;
    }

    .title,
    .team {
      font-size: 0.95rem;
      margin: 0;
    }

    .email {
      margin: 0.2rem 0;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .email a {
      color: #440099;
      text-decoration: underline;
      word-break: break-word;
    }

    .info {
      font-size: 0.85rem;
      line-height: 1.3;
    }

    .info h3 {
      margin: 0 0 0.2rem;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Find a colleague</h2>
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search by name, job title, team and expertise" />
      <select id="teamFilter">
        <option value="">All teams</option>
      </select>
      <button class="clear-filters" onclick="resetFilters()">Clear all filters</button>
    </div>
    <div id="profiles" class="grid"></div>
  </div>

  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQq-VWxY0LJS733k2cy-gFAFJOI3rnbtVzi1wSPUleNj5ulB9E-cAH0-mSo4-PQrvFsczyC2P-wfyw5/pub?output=csv";
    let allProfiles = [];
    let filteredProfiles = [];

    document.addEventListener("DOMContentLoaded", () => {
      fetch(sheetUrl)
        .then(res => res.text())
        .then(text => {
          const rows = Papa.parse(text, { header: true }).data;
          allProfiles = rows.filter(p => p['First name'] && p['Surname']);
          allProfiles.sort((a, b) => a['Surname'].localeCompare(b['Surname']));
          populateTeamFilter(allProfiles);
          displayProfiles(allProfiles);
        });

      document.getElementById("searchInput").addEventListener("input", () => {
        applyFilters();
      });

      document.getElementById("teamFilter").addEventListener("change", () => {
        applyFilters();
      });
    });

    function populateTeamFilter(profiles) {
      const select = document.getElementById("teamFilter");
      const teams = [...new Set(profiles.map(p => p.Team).filter(Boolean))].sort();
      for (const team of teams) {
        const opt = document.createElement("option");
        opt.value = team;
        opt.textContent = team;
        select.appendChild(opt);
      }
    }

    function resetFilters() {
      document.getElementById("searchInput").value = "";
      document.getElementById("teamFilter").value = "";
      displayProfiles(allProfiles);
    }

    function applyFilters() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const team = document.getElementById("teamFilter").value;

      filteredProfiles = allProfiles.filter(profile => {
        const text = (profile['First name'] + " " + profile['Surname'] + " " +
          profile['Job title'] + " " + profile['Team'] + " " + profile['Ask me about']).toLowerCase();
        return (!team || profile.Team === team) && (!search || text.includes(search));
      });

      displayProfiles(filteredProfiles);
    }

    function highlight(text, term) {
      if (!term) return text;
      const regex = new RegExp(`(${term})`, 'gi');
      return text.replace(regex, '<mark>$1</mark>');
    }

    function displayProfiles(profiles) {
      const container = document.getElementById("profiles");
      container.innerHTML = "";
      for (const profile of profiles) {
        container.appendChild(createCard(profile));
      }
    }

    function createCard(profile) {
      const card = document.createElement("div");
      card.className = "profile-card";
      card.innerHTML = `
        <img class="avatar" src="${profile.Avatar}" alt="Profile Image">
        <div class="profile-details">
          <div class="name">${profile['First name']} ${profile['Surname']}</div>
          <div class="title">${profile['Job title'] || ''}</div>
          <div class="team">${profile['Team'] || ''}</div>
          <div class="email"><a href="mailto:${profile.Email}">${profile.Email}</a></div>
          <div class="info"><h3>Ask me about:</h3> ${profile['Ask me about'] || ''}</div>
        </div>
      `;
      return card;
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</body>
</html>
